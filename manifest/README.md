## TODO

- Expose Argo web server in *base/argo.yaml* so you don't have to use Argo CLI for dashboard.
  - for overlays/dev only?
- Handle keys and passwords using `secretGenerator` (ideally they should be autogenerated on deploy-time) and https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure/
- Use `vars`

## Development

Deploy all resources for a dev environment.

```
kubectl apply -k overlays/dev
```

This will not remove previously created resources that have been deleted here, unless you add: `--prune -l app.kubernetes.io/part-of=intermine_cloud`

To uninstall all the resources, use the `apply` invocation with `delete` instead:

```
kubectl delete -k overlays/dev
```

If there have been made changes to the manifests since you deployed it, this might not delete all the resources. To achieve this, you can use:

```
kubectl delete all -l app.kubernetes.io/part-of=intermine_cloud --all-namespaces
```

**Argo UI**: `kubectl -n argo port-forward service/argo-server 2746:2746` then open https://localhost:2746 and accept the SSL certificate. Use `echo Bearer $(kubectl -n argo get secret $(kubectl -n argo get sa argo -o=jsonpath='{.secrets[0].name}') -o=jsonpath='{.data.token}' | base64 --decode)` to get the token for client authentication. Mine workflows are created in the `workflow` namespace -- remember to input this to the *Namespace* filter and hit *Enter*.

**MinIO console**: `kubectl -n compose port-forward service/compose-minio-console 9001:9001` then open http://localhost:9001 and use `kubectl -n compose get secret/compose-minio -o jsonpath='{.data.rootUser}' | base64 --decode` and `kubectl -n compose get secret/compose-minio -o jsonpath='{.data.rootPassword}' | base64 --decode` to get the access and secret keys.

## Generating base manifests

The first time you'll need to add the Helm repositories containing the charts.

```
helm repo add minio https://charts.min.io/
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add nats https://nats-io.github.io/k8s/helm/charts/
helm repo update
```

Then you can generate the manifests.

```
# Argo defaults to latest tags -- you should manually replace this with a versioned tag in the interest of avoiding breakage.
curl https://raw.githubusercontent.com/argoproj/argo-workflows/master/manifests/install.yaml > base/argo/argo.yaml
helm template compose bitnami/postgresql > base/compose/postgresql.yaml
helm template --set replicas=4 compose minio/minio > base/compose/minio.yaml
helm template nats nats/nats > base/nats/nats.yaml
pushd ../helm-operator ; kustomize build config/default > ../manifest/base/intermine_operator.yaml ; popd
```

Make sure to review the diffs, as sometimes manual changes have to be made to the source manifests.
