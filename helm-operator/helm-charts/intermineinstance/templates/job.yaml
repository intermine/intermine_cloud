{{- if .Values.builder.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{.Release.Name}}-builder-{{.Release.Revision}}"
  labels:
    app.kubernetes.io/component: builder
    {{- include "intermineinstance.labels" . | nindent 4 }}
spec:
  backoffLimit: 1
  # Not supported by Rahti.
  # ttlSecondsAfterFinished: 86400 # Delete job after 24 hours
  template:
    metadata:
      name: "{{.Release.Name}}-builder"
      labels:
        app.kubernetes.io/managed-by: {{.Release.Service | quote }}
        app.kubernetes.io/instance: {{.Release.Name | quote }}
        helm.sh/chart: "{{.Chart.Name}}-{{.Chart.Version}}"
    spec:
      volumes:
      - name: rclone-conf
        secret:
          secretName: {{.Release.Name}}-rclone-conf
          defaultMode: 420
          items:
            - key: rclone.conf
              path: rclone.conf
      - name: properties-pkl
        secret:
          secretName: {{.Release.Name}}-properties-pkl
          defaultMode: 420
          items:
            - key: properties.pkl
              path: properties.pkl
      - name: minedir
        persistentVolumeClaim:
          claimName: job-{{.Release.Name}}-minedir
      {{- if .Values.builder.objectStorage.buckets.data }}
      - name: data
        persistentVolumeClaim:
          claimName: job-{{.Release.Name}}-data
      {{- end }}
      {{- if .Values.builder.objectStorage.buckets.bio }}
      - name: bio
        persistentVolumeClaim:
          claimName: job-{{.Release.Name}}-bio
      {{- end }}
      {{- if .Values.builder.objectStorage.buckets.im }}
      - name: im
        persistentVolumeClaim:
          claimName: job-{{.Release.Name}}-im
      {{- end }}
      initContainers:
      - name: get-artifacts
        image: rclone/rclone:1.57.0
        command: ["/bin/sh", "-c"]
        args:
        - >
          rclone sync default:{{.Values.builder.objectStorage.buckets.minedir}} /mine &&
          chmod +x /mine/gradlew &&
          {{- if .Values.builder.objectStorage.buckets.data }}
          rclone sync default:{{.Values.builder.objectStorage.buckets.data}} /data &&
          {{- end }}
          {{- if .Values.builder.objectStorage.buckets.bio }}
          rclone sync default:{{.Values.builder.objectStorage.buckets.bio}} /bio &&
          chmod +x /bio/gradlew &&
          {{- end }}
          {{- if .Values.builder.objectStorage.buckets.im }}
          rclone sync default:{{.Values.builder.objectStorage.buckets.im}} /im &&
          {{- end }}
          echo
        volumeMounts:
        - mountPath: /.rclone.conf
          name: rclone-conf
          subPath: rclone.conf
        - mountPath: /mine
          name: minedir
        {{- if .Values.builder.objectStorage.buckets.data }}
        - mountPath: /data
          name: data
        {{- end }}
        {{- if .Values.builder.objectStorage.buckets.bio }}
        - mountPath: /bio
          name: bio
        {{- end }}
        {{- if .Values.builder.objectStorage.buckets.im }}
        - mountPath: /im
          name: im
        {{- end }}
      containers:
      - name: {{.Release.Name}}-builder-job
        image: "{{.Values.builder.image.repository}}:{{.Values.builder.image.tag}}"
        command: ["builder_job"]
        args:
        {{- if .Values.builder.task }}
        - "--task"
        - "{{.Values.builder.task}}"
        {{- end }}
        - "--properties-path"
        - "/home/intermine/properties.pkl"
        - "--mine-path"
        - "/home/intermine/{{.Values.builder.mineName}}"
        {{- if .Values.builder.objectStorage.buckets.bio }}
        - "--bio-path"
        - "/bio"
        {{- end }}
        {{- if .Values.builder.objectStorage.buckets.im }}
        - "--im-path"
        - "/im"
        {{- end }}
        - "--keep-alive"
        env:
        - name: PGHOST
          value: {{ template "common.names.fullname" .Subcharts.postgresql }}
        - name: PGUSERDBHOST
          value: {{ template "common.names.fullname" .Subcharts.postgresqluserdb }}
        - name: SOLR_HOST
          value: {{ template "common.names.fullname" .Subcharts.solr }}
        - name: TOMCAT_HOST
          value: {{ template "common.names.fullname" .Subcharts.tomcat }}
        volumeMounts:
        - mountPath: /home/intermine/properties.pkl
          name: properties-pkl
          subPath: properties.pkl
        - mountPath: /home/intermine/{{.Values.builder.mineName}}
          name: minedir
        {{- if .Values.builder.objectStorage.buckets.data }}
        - mountPath: /data
          name: data
        {{- end }}
        {{- if .Values.builder.objectStorage.buckets.bio }}
        - mountPath: /bio
          name: bio
        {{- end }}
        {{- if .Values.builder.objectStorage.buckets.im }}
        - mountPath: /im
          name: im
        {{- end }}
      restartPolicy: Never
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: job-{{.Release.Name}}-minedir
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 200Mi
---
{{- if .Values.builder.objectStorage.buckets.data }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: job-{{.Release.Name}}-data
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: {{.Values.builder.storageRequests.data}}
{{- end }}
---
{{- if .Values.builder.objectStorage.buckets.bio }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: job-{{.Release.Name}}-bio
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 50Mi
{{- end }}
---
{{- if .Values.builder.objectStorage.buckets.im }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: job-{{.Release.Name}}-im
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{.Release.Name}}-rclone-conf
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
type: Opaque
stringData:
  "rclone.conf": |-
    [default]
    type = s3
    provider = Other
    env_auth = false
    access_key_id = {{.Values.builder.objectStorage.accessKey}}
    secret_access_key = {{.Values.builder.objectStorage.secretKey}}
    endpoint = {{.Values.builder.objectStorage.endpoint}}
    location_constraint = regionOne
---
apiVersion: v1
kind: Secret
metadata:
  name: {{.Release.Name}}-properties-pkl
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
type: Opaque
stringData:
  "properties.pkl": |-
    {
      {{- range $k, $v := .Values.builder.properties }}
      '{{ $k }}': '{{ $v }}',
      {{- end }}
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: tomcat-users
  labels:
    {{- include "intermineinstance.labels" . | nindent 4 }}
type: Opaque
stringData:
  "tomcat-users.xml": |-
    <?xml version='1.0' encoding='utf-8'?>
    <tomcat-users xmlns="http://tomcat.apache.org/xml"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
                  version="1.0">
      <role rolename="manager-script"/>
      <role rolename="manager-jmx"/>
      <user username="tomcat" password="tomcat" roles="manager-script,manager-jmx"/>
    </tomcat-users>
{{- end }}
